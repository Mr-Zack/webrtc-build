name: Build WebRTC on Windows

# 手动触发
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. 检出仓库（如果你需要用自己的 repo 的脚本）
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. 安装依赖（Python + Git + Visual Studio Build Tools）
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        choco install git -y
        choco install visualstudio2022buildtools -y
        choco install cmake -y
        choco install ninja -y
        choco install depot_tools -y

    # 3. 拉取 WebRTC 源码
    - name: Fetch WebRTC
      shell: powershell
      run: |
        $env:PATH += ";C:\tools\depot_tools"
        mkdir webrtc
        cd webrtc
        fetch --nohooks webrtc
        cd src
        gclient sync

    # 4. 生成 Visual Studio 项目
    - name: Generate build files
      shell: powershell
      run: |
        cd webrtc\src
        gn gen out\Debug --ide=vs2022 --args="is_debug=true target_os=\"win\""

    # 5. 编译
    - name: Build WebRTC
      shell: powershell
      run: |
        cd webrtc\src
        ninja -C out\Debug
