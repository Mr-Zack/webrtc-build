name: Build WebRTC (Windows)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 180

    env:
      DEPOT_TOOLS_WIN_TOOLCHAIN: 0
      GYP_MSVS_VERSION: 2022

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0   # ✅ 关键：避免浅克隆导致版本/时间戳脚本取不到信息

    - name: Clone depot_tools
      shell: pwsh
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        "$PWD\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install VS Build Tools
      shell: pwsh
      run: |
        choco install visualstudio2022buildtools -y --package-parameters `
          "--add Microsoft.VisualStudio.Workload.VCTools `
           --add Microsoft.VisualStudio.Component.Windows11SDK.22621 `
           --includeRecommended --quiet --norestart"

    - name: Fetch WebRTC
      shell: cmd
      run: |
        mkdir webrtc
        cd webrtc
        fetch --nohooks webrtc
        cd src
        gclient sync --jobs 4
        gclient runhooks    REM ✅ 关键：生成 build\util\LASTCHANGE.committime 等文件
        dir build\util\LASTCHANGE*  REM ✅ 可选：验证文件已生成

    - name: Configure GN
      shell: cmd
      run: |
        cd webrtc\src
        gn gen out\Release --args="is_debug=false rtc_include_tests=false is_component_build=false target_cpu=\"x64\""

    - name: Build WebRTC
      shell: cmd
      run: |
        cd webrtc\src
        ninja -C out\Release -j 4

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webrtc-windows
        path: webrtc/src/out/Release
