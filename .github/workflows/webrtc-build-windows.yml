name: Build WebRTC on Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      DEPOT_TOOLS_PATH: ${{ github.workspace }}\depot_tools
      DEPOT_TOOLS_WIN_TOOLCHAIN: 0  # 使用系统 MSVC 工具链

    steps:
      # 1. 检出仓库
      - name: Checkout
        uses: actions/checkout@v3

      # 2. 安装依赖（Python, Git, 7zip）
      - name: Install dependencies
        run: |
          choco install -y python3 git 7zip
          python --version
          git --version

      # 3. 克隆 depot_tools（缓存）
      - name: Cache depot_tools
        uses: actions/cache@v3
        with:
          path: depot_tools
          key: depot_tools-v1

      - name: Clone depot_tools
        if: steps.cache-depot-tools.outputs.cache-hit != 'true'
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "%DEPOT_TOOLS_PATH%"

      # 4. 设置 depot_tools 到 PATH
      - name: Add depot_tools to PATH
        run: echo "%DEPOT_TOOLS_PATH%" >> $Env:GITHUB_PATH

      # 5. 拉取 WebRTC 源码（缓存）
      - name: Cache WebRTC source
        uses: actions/cache@v3
        id: webrtc-cache
        with:
          path: webrtc/src
          key: webrtc-src-v1

      - name: Fetch WebRTC
        shell: pwsh
        run: |
          if (!(Test-Path webrtc/src)) {
            mkdir webrtc
            cd webrtc
            & "$Env:DEPOT_TOOLS_PATH\fetch.bat" --nohooks webrtc
            cd src
            & "$Env:DEPOT_TOOLS_PATH\gclient.bat" sync
          } else {
            Write-Host "Using cached WebRTC source"
          }

      # 6. 生成 Ninja 构建文件
      - name: Generate build files
        shell: pwsh
        run: |
          cd webrtc/src
          & "$Env:DEPOT_TOOLS_PATH\gn.exe" gen out\Default --args="is_debug=false target_os=\"win\" target_cpu=\"x64\""

      # 7. 编译 WebRTC
      - name: Build WebRTC
        shell: pwsh
        run: |
          cd webrtc/src
          & "$Env:DEPOT_TOOLS_PATH\ninja.exe" -C out\Default

      # 8. 打印完成
      - name: Done
        run: echo "WebRTC build completed!"
