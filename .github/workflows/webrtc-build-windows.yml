name: Build WebRTC (Windows)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 180

    env:
      DEPOT_TOOLS_WIN_TOOLCHAIN: 0
      GYP_MSVS_VERSION: 2022

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone depot_tools
        shell: pwsh
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          "$PWD\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify depot_tools tools
        shell: cmd
        run: |
          where fetch
          where gclient
          where gn
          where ninja

      - name: Install VS Build Tools
        shell: pwsh
        run: |
          choco install visualstudio2022buildtools -y --package-parameters `
            "--add Microsoft.VisualStudio.Workload.VCTools `
             --add Microsoft.VisualStudio.Component.Windows11SDK.22621 `
             --includeRecommended --quiet --norestart"

      - name: Fetch WebRTC (nohooks) + sync
        shell: cmd
        run: |
          if not exist webrtc mkdir webrtc
          cd webrtc
          fetch --nohooks webrtc
          cd src
          gclient sync --jobs 4
          dir build\util

      - name: Run hooks
        shell: cmd
        run: |
          cd webrtc\src
          gclient runhooks
          dir build\util
          dir build\util\LASTCHANGE*

      - name: Ensure LASTCHANGE.committime exists (fallback)
        if: ${{ always() }}
        shell: pwsh
        run: |
          cd webrtc/src
          New-Item -Force -ItemType Directory build/util | Out-Null

          if (-not (Test-Path "build/util/LASTCHANGE.committime")) {
            Write-Host "LASTCHANGE.committime missing -> generating fallback"
            try {
              $ct = git log -1 --format=%ct
              if (-not $ct) { throw "empty commit time" }
              Set-Content -Path build/util/LASTCHANGE.committime -Value $ct
            } catch {
              $ts = [int][double]::Parse((Get-Date -UFormat %s))
              Set-Content -Path build/util/LASTCHANGE.committime -Value $ts
            }
          }

          Write-Host "LASTCHANGE.committime content:"
          Get-Content build/util/LASTCHANGE.committime

      - name: Configure GN
        shell: cmd
        run: |
          cd webrtc\src
          gn gen out\Release --args="is_debug=false rtc_include_tests=false is_component_build=false target_cpu=\"x64\""

      - name: Build WebRTC
        shell: cmd
        run: |
          cd webrtc\src
          ninja -C out\Release -j 4

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-windows
          path: webrtc/src/out/Release
