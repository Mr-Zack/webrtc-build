name: Build WebRTC (Windows)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    # ğŸ”´ å…³é”®ï¼šä½¿ç”¨ GitHub Runner è‡ªå¸¦ VS2022ï¼Œä¸ç”¨ Google çš„ toolchain
    env:
      DEPOT_TOOLS_WIN_TOOLCHAIN: 0

    steps:
    # 1ï¸âƒ£ Checkoutï¼ˆåªæ˜¯ä¸ºäº†æ”¾ workflowï¼Œæœ¬èº«ä¸å‚ä¸ç¼–è¯‘ï¼‰
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2ï¸âƒ£ æ‹‰ depot_tools
    - name: Clone depot_tools
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "$PWD\depot_tools" >> $env:GITHUB_PATH

    # 3ï¸âƒ£ æ‹‰ WebRTC æºç  + åŒæ­¥ä¾èµ–
    - name: Fetch WebRTC
      shell: cmd
      run: |
        mkdir webrtc
        cd webrtc
        fetch webrtc
        cd src
        gclient sync
        gclient runhooks

    # 4ï¸âƒ£ ç”Ÿæˆ LASTCHANGE / LASTCHANGE.committimeï¼ˆå®˜æ–¹æ­£ç¡®æ–¹å¼ï¼‰
    - name: Generate LASTCHANGE
      shell: cmd
      run: |
        cd webrtc\src
        python build\util\write_lastchange.py

    # 5ï¸âƒ£ GN é…ç½®ï¼ˆé™æ€åº“ï¼Œé€‚åˆ MixedReality.WebRTCï¼‰
    - name: Configure GN
      shell: cmd
      run: |
        cd webrtc\src
        gn gen out\Release --args="^
          is_debug=false ^
          rtc_include_tests=false ^
          rtc_build_examples=false ^
          is_component_build=false ^
          use_rtti=true ^
          treat_warnings_as_errors=false
        "

    # 6ï¸âƒ£ ç¼–è¯‘ï¼ˆé™åˆ¶å¹¶è¡Œï¼Œé˜²æ­¢ Windows Runner å†…å­˜ç‚¸ï¼‰
    - name: Build WebRTC
      shell: cmd
      run: |
        cd webrtc\src
        ninja -C out\Release -j2

    # 7ï¸âƒ£ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webrtc-windows-release
        path: webrtc/src/out/Release
